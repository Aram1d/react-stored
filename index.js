"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.readStore=exports.useStore=exports.addSchema=exports.config=void 0;var _react=require("react"),storeConfig={keyPrefix:"",storage:"undefined"!=typeof window&&window.localStorage,crossTab:!1,serialize:JSON.stringify,deserialize:JSON.parse,schemas:[]},config=function(a){a.hasOwnProperty("crossTab")&&"undefined"!=typeof window&&a.crossTab!==storeConfig.crossTab&&window[a.crossTab?"addEventListener":"removeEventListener"]("storage",callUpdatersFromEvent),Object.assign(storeConfig,a)};exports.config=config;var addSchema=function(a,b,c){storeConfig.schemas.push({key:a,init:b,assert:c})};exports.addSchema=addSchema;var storeUpdaters={},addUpdater=function(a,b){storeUpdaters.hasOwnProperty(a)?storeUpdaters[a].push(b):storeUpdaters[a]=[b]},removeUpdater=function(a,b){if(storeUpdaters.hasOwnProperty(a)){var c=storeUpdaters[a].indexOf(b);-1!==c&&storeUpdaters[a].splice(c,1)}},callUpdaters=function(a,b){if(storeUpdaters.hasOwnProperty(a)){var c=!0,d=!1,e=void 0;try{for(var f,g,h=storeUpdaters[a][Symbol.iterator]();!(c=(f=h.next()).done);c=!0)g=f.value,g(b)}catch(a){d=!0,e=a}finally{try{c||null==h.return||h.return()}finally{if(d)throw e}}}},callUpdatersFromEvent=function(a){a.storageArea===storeConfig.storage&&a.key&&a.key.startsWith(storeConfig.keyPrefix)&&null!==a.oldValue&&null!==a.newValue&&callUpdaters(a.key.substring(storeConfig.keyPrefix.length),storeConfig.deserialize(a.newValue))},useStore=function(a,b,c){var d=(0,_react.useRef)(),e=(0,_react.useMemo)(function(){return storeConfig.schemas.find(function(b){return"string"==typeof b.key?b.key===a:b.key.test(a)})},[a]);(0,_react.useMemo)(function(){var f=[b,e&&e.init,null].find(function(a){return a!==void 0}),g=c||e&&e.assert;try{var h=storeConfig.storage.getItem("".concat(storeConfig.keyPrefix).concat(a));if(null===h)throw new Error;var i=storeConfig.deserialize(h);if(g&&!g(i))throw new Error;d.current=i}catch(b){storeConfig.storage.setItem("".concat(storeConfig.keyPrefix).concat(a),storeConfig.serialize(f)),d.current=f}},[a,b,c,e]);var f=(0,_react.useState)({})[1];(0,_react.useEffect)(function(){var b=function(a){d.current=a,f({})};return addUpdater(a,b),function(){removeUpdater(a,b)}},[a]);var g=(0,_react.useCallback)(function(b){"function"==typeof b&&(b=b(d.current)),b!==d.current&&(storeConfig.storage.setItem("".concat(storeConfig.keyPrefix).concat(a),storeConfig.serialize(b)),callUpdaters(a,b))},[a]);return[d.current,g]};exports.useStore=useStore;var readStore=function(a){var b=storeConfig.storage.getItem("".concat(storeConfig.keyPrefix).concat(a));return storeConfig.deserialize(b)};exports.readStore=readStore;
