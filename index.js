"use strict";var _react=require("react");Object.defineProperty(exports,"__esModule",{value:!0}),exports.readStore=exports.useStore=exports.addSchema=exports.config=void 0;function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a)){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}}function _arrayWithHoles(a){if(Array.isArray(a))return a}var storeConfig={keyPrefix:"",storage:window.localStorage,crossTab:!1,serialize:JSON.stringify,deserialize:JSON.parse,schemas:[]},config=function(a){"crossTab"in a&&a.crossTab!==storeConfig.crossTab&&window[a.crossTab?"addEventListener":"removeEventListener"]("storage",callUpdatersFromEvent),Object.assign(storeConfig,a)};exports.config=config;var addSchema=function(a,b,c){storeConfig.schemas.push({key:a,init:b,assert:c})};exports.addSchema=addSchema;var storeUpdaters={},addUpdater=function(a,b){a in storeUpdaters?storeUpdaters[a].push(b):storeUpdaters[a]=[b]},removeUpdater=function(a,b){if(a in storeUpdaters){var c=storeUpdaters[a].indexOf(b);-1!==c&&storeUpdaters[a].splice(c,1)}},callUpdaters=function(a,b){if(a in storeUpdaters){var c=!0,d=!1,e=void 0;try{for(var f,g,h=storeUpdaters[a][Symbol.iterator]();!(c=(f=h.next()).done);c=!0)g=f.value,g(b)}catch(a){d=!0,e=a}finally{try{c||null==h.return||h.return()}finally{if(d)throw e}}}},callUpdatersFromEvent=function(a){a.storageArea===storeConfig.storage&&a.key&&a.key.startsWith(storeConfig.keyPrefix)&&null!==a.oldValue&&null!==a.newValue&&callUpdaters(a.key.substring(storeConfig.keyPrefix.length),storeConfig.deserialize(a.newValue))},useStore=function(a,b,c){var d=(0,_react.useRef)(),e=(0,_react.useMemo)(function(){return storeConfig.schemas.find(function(b){return"string"==typeof b.key?b.key===a:b.key.test(a)})},[a]);(0,_react.useMemo)(function(){var f=[b,e&&e.init,null].find(function(a){return a!==void 0}),g=c||e&&e.assert;try{var h=storeConfig.storage.getItem("".concat(storeConfig.keyPrefix).concat(a));if(null===h)throw new Error;var i=storeConfig.deserialize(h);if(g&&!g(i))throw new Error;d.current=i}catch(b){storeConfig.storage.setItem("".concat(storeConfig.keyPrefix).concat(a),storeConfig.serialize(f)),d.current=f}},[a,b,c,e]);var f=(0,_react.useState)({}),g=_slicedToArray(f,2),h=g[1];(0,_react.useEffect)(function(){var b=function(a){d.current=a,h({})};return addUpdater(a,b),function(){removeUpdater(a,b)}},[a]);var i=(0,_react.useCallback)(function(b){"function"==typeof b&&(b=b(d.current)),b!==d.current&&(storeConfig.storage.setItem("".concat(storeConfig.keyPrefix).concat(a),storeConfig.serialize(b)),callUpdaters(a,b))},[a]);return[d.current,i]};exports.useStore=useStore;var readStore=function(a){var b=storeConfig.storage.getItem("".concat(storeConfig.keyPrefix).concat(a));return storeConfig.deserialize(b)};exports.readStore=readStore;
